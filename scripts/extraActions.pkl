//===----------------------------------------------------------------------===//
// Copyright Â© 2025 Apple Inc. and the Pkl project authors. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//===----------------------------------------------------------------------===//
import "@com.github.actions.contrib/generate-action.pkl" as generate
import "@io.github.typesafegithub/ActionTypes.pkl"

function enumType(variants: List<String>) = new ActionTypes.Property {
  type = "enum"
  `allowed-values` {
    ...variants
  }
}

local typings: Mapping<String, ActionTypes> = new {
  ["dawidd6/action-download-artifact@v11"] {
    inputs {
      ["github_token"] { type = "string" }
      ["workflow"] { type = "string" }
      ["workflow_search"] { type = "boolean" }
      ["workflow_conclusion"] =
        enumType(
          List(
            "failure",
            "success",
            "neutral",
            "cancelled",
            "skipped",
            "timed_out",
            "action_required",
            "completed",
            "in_progress",
            "queued",
            // empty is intentional
            ""
          )
        )
      ["pr"] { type = "string" }
      ["commit"] { type = "string" }
      ["branch"] { type = "string" }
      ["ref"] { type = "string" }
      ["event"] { type = "string" }
      ["dry_run"] { type = "boolean" }
      ["run_id"] { type = "integer" }
      ["run_number"] { type = "integer" }
      ["name"] { type = "string" }
      ["name_is_regexp"] { type = "boolean" }
      ["path"] { type = "string" }
      ["repo"] { type = "string" }
      ["check_artifacts"] { type = "boolean" }
      ["search_artifacts"] { type = "boolean" }
      ["skip_unpack"] { type = "boolean" }
      ["if_no_artifact_found"] = enumType(List("fail", "warn", "ignore"))
      ["allow_forks"] { type = "boolean" }
      ["use_unzip"] { type = "boolean" }
      ["merge_multiple"] { type = "boolean" }
    }
  }
  ["actions-rust-lang/setup-rust-toolchain@v1"] {
    inputs {
      ["toolchain"] {
        type = "list"
        `list-item` { type = "string" }
        separator = ","
      }
      ["target"] { type = "string" }
      ["components"] {
        type = "list"
        `list-item` { type = "string" }
        separator = ","
      }
      ["cache"] { type = "boolean" }
      ["cache-directories"] {
        type = "list"
        separator = "\n"
        `list-item` { type = "string" }
      }
      ["cache-workspaces"] {
        type = "list"
        separator = "\n"
        `list-item` { type = "string" }
      }
      ["cache-on-failure"] { type = "boolean" }
      ["cache-key"] { type = "string" }
      ["cache-shared-key"] { type = "string" }
      ["cache-bin"] { type = "boolean" }
      ["cache-provider"] {
        type = "enum"
        `allowed-values` {
          "github"
          "buildjet"
          "warpbuild"
        }
      }
      ["cache-all-crates"] { type = "boolean" }
      ["cache-workspace-crates"] { type = "boolean" }
      ["matcher"] { type = "boolean" }
      ["rustflags"] { type = "string" }
      ["override"] { type = "boolean" }
      ["rust-src-dir"] { type = "string" }
    }
  }
}

function generateActions(_actionName: String, _actionTypes: ActionTypes) =
  let (
    generator = (generate) {
      actionName = _actionName
      pathPrefix = "packages/com.github.actions.community"
      actionTypes = _actionTypes
      moduleNamePrefix = "com.github.actions.community"
      abstractTypedStepModule = "@com.github.actions/AbstractTypedStep.pkl"
    }
  )
    generator.files

fixed files: Mapping<String, FileOutput> = new {
  for (actionName, actionTypes in typings) {
    ...generateActions(actionName, actionTypes)
  }
}
