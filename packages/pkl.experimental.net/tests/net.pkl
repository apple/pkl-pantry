//===----------------------------------------------------------------------===//
// Copyright Â© 2024 Apple Inc. and the Pkl project authors. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//===----------------------------------------------------------------------===//
module pkl.experimental.net.tests.net

amends "pkl:test"

import "../net.pkl"

local baseIP = net.IPv6Address("::")

facts {
  ["MACAddress"] {
    net.MACAddress("34:73:5A:FA:AF:22").eui64(baseIP).toString() == "0000:0000:0000:0000:3673:5aff:fefa:af22"
  }
  ["IPv4AddressString"] {
    "0.0.0.0" is net.IPv4AddressString
    "127.0.0.1" is net.IPv4AddressString
    "1.1.1.1" is net.IPv4AddressString
    "000.000.000.000" is net.IPv4AddressString
    "255.255.255.255" is net.IPv4AddressString
    !("0000.0.0.0" is net.IPv4AddressString)
    !("256.0.0.0" is net.IPv4AddressString)
    !("260.0.0.0" is net.IPv4AddressString)
    !("300.0.0.0" is net.IPv4AddressString)
    !("1.1.1" is net.IPv4AddressString)
    !("1.1.1." is net.IPv4AddressString)
    !("1.1.1.1." is net.IPv4AddressString)
    !("1.a.1.1" is net.IPv4AddressString)
    !("1..1.1" is net.IPv4AddressString)
    !("1..1.1.1" is net.IPv4AddressString)
    !(".1.1.1" is net.IPv4AddressString)
    !(".1.1.1.1" is net.IPv4AddressString)
    !("" is net.IPv4AddressString)
  }
  ["IPv6AddressString (pure IPv6)"] {
    "0:0:0:0:0:0:0:0" is net.IPv6AddressString
    "1:2:3:4:5:6:7:8" is net.IPv6AddressString
    "FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF" is net.IPv6AddressString
    "ffff::" is net.IPv6AddressString
    "::" is net.IPv6AddressString
    "::1" is net.IPv6AddressString
    "::1:2:3:4:5:6:7" is net.IPv6AddressString
    "1::" is net.IPv6AddressString
    "1:2:3:4:5:6:7::" is net.IPv6AddressString
    "::1" is net.IPv6AddressString
    "::1:2:3:4:5:6:7" is net.IPv6AddressString
    "1:2:3:4:5:6::7" is net.IPv6AddressString
    "1:2:3:4:5::6:7" is net.IPv6AddressString
    "1:2:3:4::5:6:7" is net.IPv6AddressString
    "1:2:3::4:5:6:7" is net.IPv6AddressString
    "1:2::3:4:5:6:7" is net.IPv6AddressString
    "1::2:3:4:5:6:7" is net.IPv6AddressString
    "1:2:3:4:5::6" is net.IPv6AddressString
    "1:2:3:4::5" is net.IPv6AddressString
    "1:2:3::4" is net.IPv6AddressString
    "1:2::3" is net.IPv6AddressString
    "1::2" is net.IPv6AddressString
    !("1:2:3:4:5:6:7:8:9" is net.IPv6AddressString)
    !("1:2:3:4:5:6:7:" is net.IPv6AddressString)
    !("1:2:3:4:5:6:7:8:" is net.IPv6AddressString)
    !(":1:2:3:4:5:6:7" is net.IPv6AddressString)
    !(":1:2:3:4:5:6:7:8" is net.IPv6AddressString)
    !("::1:2:3:4:5:6:7:8" is net.IPv6AddressString)
    !("1:2:3:4:5:6:7:8::" is net.IPv6AddressString)
    !("1::2::" is net.IPv6AddressString)
    !("::1::2" is net.IPv6AddressString)
    !("1::g" is net.IPv6AddressString)
    !("1:::2" is net.IPv6AddressString)
    !("FFFFF::" is net.IPv6AddressString)
    !("1.2.3.4" is net.IPv6AddressString)
    !("" is net.IPv6AddressString)
  }
  ["IPv6AddressString (IPv4-compatible)"] {
    "::0.0.0.0" is net.IPv6AddressString
    "::000.000.000.000" is net.IPv6AddressString
    "::255.255.255.255" is net.IPv6AddressString
    !("::256.0.0.0" is net.IPv6AddressString)
    !("::260.0.0.0" is net.IPv6AddressString)
    !("::300.0.0.0" is net.IPv6AddressString)
    !("::0000.0.0.0" is net.IPv6AddressString)
    !("::a.0.0.0" is net.IPv6AddressString)
    !("::0.0.0" is net.IPv6AddressString)
    !("::0.0.0." is net.IPv6AddressString)
    !("::0.0.0.0." is net.IPv6AddressString)
    !("::0.0.0.0.0" is net.IPv6AddressString)
  }
  ["IPv6AddressString (IPv4-mapped)"] {
    "::ffff:0.0.0.0" is net.IPv6AddressString
    "::ffff:000.000.000.000" is net.IPv6AddressString
    "::ffff:255.255.255.255" is net.IPv6AddressString
    !("::ffff:256.0.0.0" is net.IPv6AddressString)
    !("::ffff:260.0.0.0" is net.IPv6AddressString)
    !("::ffff:300.0.0.0" is net.IPv6AddressString)
    !("::ffff:0000.0.0.0" is net.IPv6AddressString)
    !("::ffff:a.0.0.0" is net.IPv6AddressString)
    !("::ffff:0.0.0" is net.IPv6AddressString)
    !("::ffff:0.0.0." is net.IPv6AddressString)
    !("::ffff:0.0.0.0." is net.IPv6AddressString)
    !("::ffff:0.0.0.0.0" is net.IPv6AddressString)
  }
  ["IPv6AddressString (IPv4-translated)"] {
    "::ffff:0:0.0.0.0" is net.IPv6AddressString
    "::ffff:0000:0.0.0.0" is net.IPv6AddressString
    "::ffff:0:255.255.255.255" is net.IPv6AddressString
    "::ffff:0:000.000.000.000" is net.IPv6AddressString
    !("::ffff:0:256.0.0.0" is net.IPv6AddressString)
    !("::ffff:0:260.0.0.0" is net.IPv6AddressString)
    !("::ffff:0:300.0.0.0" is net.IPv6AddressString)
    !("::ffff:0:0000.0.0.0" is net.IPv6AddressString)
    !("::ffff:0:a.0.0.0" is net.IPv6AddressString)
    !("::ffff:0:0.0.0" is net.IPv6AddressString)
    !("::ffff:0:0.0.0." is net.IPv6AddressString)
    !("::ffff:0:0.0.0.0." is net.IPv6AddressString)
    !("::ffff:0:0.0.0.0.0" is net.IPv6AddressString)
  }
  ["IPv6AddressString (IPv4-embedded)"] {
    "64:ff9b::0.0.0.0" is net.IPv6AddressString
    "0::0.0.0.0" is net.IPv6AddressString
    "0:0:0:0::0.0.0.0" is net.IPv6AddressString
    "ffff:ffff:ffff:ffff::255.255.255.255" is net.IPv6AddressString
    "64:ff9b::255.255.255.255" is net.IPv6AddressString
    "64:ff9b::000.000.000.000" is net.IPv6AddressString
    !("64:ff9b::256.0.0.0" is net.IPv6AddressString)
    !("64:ff9b::260.0.0.0" is net.IPv6AddressString)
    !("64:ff9b::300.0.0.0" is net.IPv6AddressString)
    !("64:ff9b::0000.0.0.0" is net.IPv6AddressString)
    !("64:ff9b::a.0.0.0" is net.IPv6AddressString)
    !("64:ff9b::0.0.0" is net.IPv6AddressString)
    !("64:ff9b::0.0.0." is net.IPv6AddressString)
    !("64:ff9b::0.0.0.0." is net.IPv6AddressString)
    !("64:ff9b::0.0.0.0.0" is net.IPv6AddressString)
  }
  ["IPv6AddressString (miscellaneous IPv4)"] {
    "0:0:0:0:0:0:0.0.0.0" is net.IPv6AddressString
    "1:2:3:4:5:6:1.2.3.4" is net.IPv6AddressString
    "FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:255.255.255.255" is net.IPv6AddressString
    "::1:1.2.3.4" is net.IPv6AddressString
    "::1:2:3:4:5:1.2.3.4" is net.IPv6AddressString
    "1::1.2.3.4" is net.IPv6AddressString
    "1:2:3:4:5::1.2.3.4" is net.IPv6AddressString
    "1:2:3:4::5:1.2.3.4" is net.IPv6AddressString
    "1:2:3::4:5:1.2.3.4" is net.IPv6AddressString
    "1:2::3:4:5:1.2.3.4" is net.IPv6AddressString
    "1::2:3:4:5:1.2.3.4" is net.IPv6AddressString
    "1:2:3::4:1.2.3.4" is net.IPv6AddressString
    "1:2::3:1.2.3.4" is net.IPv6AddressString
    "1::2:1.2.3.4" is net.IPv6AddressString
    "::1.2.3.4" is net.IPv6AddressString
    "::0.0.0.0" is net.IPv6AddressString
    !("1:2:3:4:5:6:7:1.2.3.4" is net.IPv6AddressString)
    !("1:2:3:4:5:6:1.2.3" is net.IPv6AddressString)
    !("1:2:3:4:5:6:1.2.3.4.5" is net.IPv6AddressString)
    !("1:2:3:4:5:6::1.2.3.4" is net.IPv6AddressString)
    !(":1:2:3:4:5:1.2.3.4" is net.IPv6AddressString)
    !(":1:2:3:4:5:6:1.2.3.4" is net.IPv6AddressString)
    !("::1:2:3:4:5:6:1.2.3.4" is net.IPv6AddressString)
    !("1::2::1.2.3.4" is net.IPv6AddressString)
    !("1::2::3:1.2.3.4" is net.IPv6AddressString)
    !("::1::2:1.2.3.4" is net.IPv6AddressString)
    !("::1::1.2.3.4" is net.IPv6AddressString)
    !("1:::2:1.2.3.4" is net.IPv6AddressString)
    !("FFFFF::1.2.3.4" is net.IPv6AddressString)
    !("1.2.3.4::" is net.IPv6AddressString)
  }
  ["Scoped IPv6AddressString (link-local unicast)"] {
    "fe80::%1" is net.IPv6AddressString
    "FE80::%1" is net.IPv6AddressString
    "fe80::%999" is net.IPv6AddressString
    "fe80:0:0:0:0:0:0:0%1" is net.IPv6AddressString
    "fe80:0:0:0:a:b:c:d%2" is net.IPv6AddressString
    "fe80::aaaa%0" is net.IPv6AddressString
    "fe80:0:0:0:1::%1" is net.IPv6AddressString
    "fe80:0:0::1%2" is net.IPv6AddressString
    !("fe80:1::%0" is net.IPv6AddressString)
    !("fe80::a:b:c:d:e%0" is net.IPv6AddressString)
    !("fe81::%1" is net.IPv6AddressString)
    !("febf::%1" is net.IPv6AddressString)
    !("fe80::%" is net.IPv6AddressString)
    !("fe80::%a" is net.IPv6AddressString)
    !("fe80::%eth0" is net.IPv6AddressString)
    !("fe80:0:0:1::%1" is net.IPv6AddressString)
    !("fe80::%-1" is net.IPv6AddressString)
    !("fe80::% 1" is net.IPv6AddressString)
    !("fe80::%%1" is net.IPv6AddressString)
    !("fe80::%1%1" is net.IPv6AddressString)
  }
  ["Scoped IPv6AddressString (site-local unicast)"] {
    "fec0::%1" is net.IPv6AddressString
    "FEC0::%1" is net.IPv6AddressString
    "fefe::%1" is net.IPv6AddressString
    "fec0::%999" is net.IPv6AddressString
    "fec0:0:0:0:0:0:0:0%0" is net.IPv6AddressString
    "fefe::1%1" is net.IPv6AddressString
    "fec1:2:3:4::8%1" is net.IPv6AddressString
    "fec1::3:4:5:6:7:8%1" is net.IPv6AddressString
    !("fec0::%" is net.IPv6AddressString)
    !("fec0::%-1" is net.IPv6AddressString)
    !("fec0::% 1" is net.IPv6AddressString)
    !("fec0::%%1" is net.IPv6AddressString)
    !("fec0::%1%1" is net.IPv6AddressString)
    !("fec0::%a" is net.IPv6AddressString)
    !("fec0::%eth0" is net.IPv6AddressString)
    !("fec0:1:2:3:4:5:6:7:8%1" is net.IPv6AddressString)
  }
  ["Scoped IPv6AddressString (multicast)"] {
    "ff00::%1" is net.IPv6AddressString
    "FF00::%1" is net.IPv6AddressString
    "ff0f::%1" is net.IPv6AddressString
    "ff1f::%1" is net.IPv6AddressString
    "ffff::%1" is net.IPv6AddressString // we don't restrict flags, for future compatibility reasons
    "ff00::%999" is net.IPv6AddressString
    "ff0d:0:0:0:0:0:0:0%0" is net.IPv6AddressString
    "ff00::7:8%0" is net.IPv6AddressString
    "ff00:2:3:4::8%0" is net.IPv6AddressString
    !("ff0e::%1" is net.IPv6AddressString) // global scope
    !("fffe::%1" is net.IPv6AddressString) // global scope
    !("FF0E::%1" is net.IPv6AddressString) // global scope
    !("ff00::%-1" is net.IPv6AddressString)
    !("ff00::% 1" is net.IPv6AddressString)
    !("ff00::%" is net.IPv6AddressString)
    !("ff00::%a" is net.IPv6AddressString)
    !("ff00::%eth0" is net.IPv6AddressString)
    !("ff00::%1%1" is net.IPv6AddressString)
    !("ff00:1:2:3:4:5:6:7:8%1" is net.IPv6AddressString)
  }
  ["Global IPv6AddressString can't be scoped"] {
    !("::%0" is net.IPv6AddressString) // technically this is implementation-defined, we don't support it
    !("::1%0" is net.IPv6AddressString)
    !("0:0:0:0:0:0:0:0%0" is net.IPv6AddressString)
    !("a:b:c:d:1:2:3:4%0" is net.IPv6AddressString)
    !("::1.2.3.4%0" is net.IPv6AddressString) // IPv6+IPv4 syntax implies global scope
    !("::ffff:1.2.3.4%0" is net.IPv6AddressString) // IPv4-mapped can be scoped in some implementations, but not ours
    !("0:fe80::%0" is net.IPv6AddressString)
    !("::fe80%0" is net.IPv6AddressString)
    !("fdff::%0" is net.IPv6AddressString)
  }
  ["IPv4CIDRString"] {
    "0.0.0.0/1" is net.IPv4CIDRString
    "255.255.255.255/32" is net.IPv4CIDRString
    !("0.0.0.0/" is net.IPv4CIDRString)
    !("0.0.0.0/100" is net.IPv4CIDRString)
    !("0.0.0.0/a" is net.IPv4CIDRString)
    !("/10" is net.IPv4CIDRString)
    !("" is net.IPv4CIDRString)
  }
  ["IPv6CIDRString"] {
    "fe80::/10" is net.IPv6CIDRString
    "::1/128" is net.IPv6CIDRString
    "::1.2.3.4/96" is net.IPv6CIDRString
    "fe80::%2/10" is net.IPv6CIDRString
    !("fe80::/" is net.IPv6CIDRString)
    !("fe80::/1000" is net.IPv6CIDRString)
    !("fe80::/a" is net.IPv6CIDRString)
    !("/10" is net.IPv6CIDRString)
    !("" is net.IPv6CIDRString)
    !("0.0.0.0/10" is net.IPv6CIDRString)
  }
  ["IPv4AddressPortString"] {
    "0.0.0.0:0" is net.IPv4AddressPortString
    "255.255.255.255:65535" is net.IPv4AddressPortString
    !("0.0.0.0:" is net.IPv4AddressPortString)
    !("0.0.0.0:123456" is net.IPv4AddressPortString)
    !(":1" is net.IPv4AddressPortString)
    !("" is net.IPv4AddressPortString)
    !("0.0.0.0:a" is net.IPv4AddressPortString)
    !("[0.0.0.0]:1" is net.IPv4AddressPortString)
  }
  ["IPv6AddressPortString"] {
    "[::1]:80" is net.IPv6AddressPortString
    "[::]:1" is net.IPv6AddressPortString
    "[fe80::]:65535" is net.IPv6AddressPortString
    "[fe80::%2]:65535" is net.IPv6AddressPortString
    !("[::1]:" is net.IPv6AddressPortString)
    !("[::1]:123456" is net.IPv6AddressPortString)
    !(":1" is net.IPv6AddressPortString)
    !("" is net.IPv6AddressPortString)
    !("[::1]:a" is net.IPv6AddressPortString)
    !("0.0.0.0:1" is net.IPv6AddressPortString)
    !("[0.0.0.0]:1" is net.IPv6AddressPortString)
    !("::1:10" is net.IPv6AddressPortString)
  }
  ["IPv4AddressString can't contain unicode digits"] {
    // U+FF11 is FULLWIDTH DIGIT ONE
    !("25\u{FF11}.0.0.0" is net.IPv4AddressString)
    !("20\u{FF11}.0.0.0" is net.IPv4AddressString)
    !("2\u{FF11}0.0.0.0" is net.IPv4AddressString)
    !("10\u{FF11}.0.0.0" is net.IPv4AddressString)
    !("1\u{FF11}0.0.0.0" is net.IPv4AddressString)
    !("\u{FF11}00.0.0.0" is net.IPv4AddressString)
    !("00\u{FF11}.0.0.0" is net.IPv4AddressString)
    !("0\u{FF11}0.0.0.0" is net.IPv4AddressString)
    !("0\u{FF11}.0.0.0" is net.IPv4AddressString)
    !("\u{FF11}0.0.0.0" is net.IPv4AddressString)
    !("\u{FF11}.0.0.0" is net.IPv4AddressString)
  }
  ["IPv6AddressString can't contain unicode digits"] {
    !("\u{FF11}::" is net.IPv6AddressString)
    !("fe80::%\u{FF11}" is net.IPv6AddressString)
    !("::25\u{FF11}.0.0.0" is net.IPv6AddressString)
    !("::20\u{FF11}.0.0.0" is net.IPv6AddressString)
    !("::2\u{FF11}0.0.0.0" is net.IPv6AddressString)
    !("::10\u{FF11}.0.0.0" is net.IPv6AddressString)
    !("::1\u{FF11}0.0.0.0" is net.IPv6AddressString)
    !("::\u{FF11}00.0.0.0" is net.IPv6AddressString)
    !("::00\u{FF11}.0.0.0" is net.IPv6AddressString)
    !("::0\u{FF11}0.0.0.0" is net.IPv6AddressString)
    !("::0\u{FF11}.0.0.0" is net.IPv6AddressString)
    !("::\u{FF11}0.0.0.0" is net.IPv6AddressString)
    !("::\u{FF11}.0.0.0" is net.IPv6AddressString)
  }
  ["IPv4AddressPortString can't contain unicode digits in the port"] {
    !("127.0.0.1:\u{FF11}" is net.IPAddressPortString)
  }
  ["IPv6AddressPortString can't contain unicode digits in the port"] {
    !("[::1]:\u{FF11}" is net.IPAddressPortString)
  }
  ["IPv4CIDRString can't contain unicode digits in the suffix"] {
    !("10.0.0.0/\u{FF11}" is net.IPv4CIDRString)
  }
  ["IPv6CIDRString can't contain unicode digits in the suffix"] {
    !("::1/\u{FF11}" is net.IPv6CIDRString)
  }
}
